<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Universal CNC Spindle Motor Controller: motorstuff.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Universal CNC Spindle Motor Controller
   &#160;<span id="projectnumber">Version 1.0</span>
   </div>
   <div id="projectbrief">Interfaces Standard 110v routers with a Stm32 Nucleo Microcontroller</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">motorstuff.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="userInterface_8h_source.html">userInterface.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="motorstuff_8h_source.html">motorstuff.h</a>&quot;</code><br />
<code>#include &quot;taskshare.h&quot;</code><br />
<code>#include &quot;taskqueue.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a44ba8784fe4a2a034c95fe7b6df4db7a"><td class="memItemLeft" align="right" valign="top"><a id="a44ba8784fe4a2a034c95fe7b6df4db7a"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>motorEncoderPinA</b>&#160;&#160;&#160;7</td></tr>
<tr class="separator:a44ba8784fe4a2a034c95fe7b6df4db7a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a07ef4e9eadb3aa78b9af0aeb78db9d5a"><td class="memItemLeft" align="right" valign="top"><a id="a07ef4e9eadb3aa78b9af0aeb78db9d5a"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>motorEncoderPinB</b>&#160;&#160;&#160;8</td></tr>
<tr class="separator:a07ef4e9eadb3aa78b9af0aeb78db9d5a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4db359c092498725b92ca1bb9bf4cc74"><td class="memItemLeft" align="right" valign="top"><a id="a4db359c092498725b92ca1bb9bf4cc74"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>motorPWMpin</b>&#160;&#160;&#160;A3</td></tr>
<tr class="separator:a4db359c092498725b92ca1bb9bf4cc74"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ade7829a9e983294f1abc8fa961f000a5"><td class="memItemLeft" align="right" valign="top"><a id="ade7829a9e983294f1abc8fa961f000a5"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>motorDIRpin</b>&#160;&#160;&#160;2</td></tr>
<tr class="separator:ade7829a9e983294f1abc8fa961f000a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a5c781e3473a1213c5c10259c7dae3e3b"><td class="memItemLeft" align="right" valign="top"><a id="a5c781e3473a1213c5c10259c7dae3e3b"></a>
Queue&lt; int &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>actualMotorSpeed</b> (30,&quot;Buffer&quot;)</td></tr>
<tr class="separator:a5c781e3473a1213c5c10259c7dae3e3b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9d451d19ddf1b607029c096a6ef6d8c2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motorstuff_8cpp.html#a9d451d19ddf1b607029c096a6ef6d8c2">motorISR</a> ()</td></tr>
<tr class="memdesc:a9d451d19ddf1b607029c096a6ef6d8c2"><td class="mdescLeft">&#160;</td><td class="mdescRight">An interrupt service routine for calculating the speed of the motor.  <a href="motorstuff_8cpp.html#a9d451d19ddf1b607029c096a6ef6d8c2">More...</a><br /></td></tr>
<tr class="separator:a9d451d19ddf1b607029c096a6ef6d8c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a058acbc8e5528a36395b0f7df1bf308c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motorstuff_8cpp.html#a058acbc8e5528a36395b0f7df1bf308c">task_MotorStuff</a> (void *p_params)</td></tr>
<tr class="memdesc:a058acbc8e5528a36395b0f7df1bf308c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Task which interacts with a user.  <a href="motorstuff_8cpp.html#a058acbc8e5528a36395b0f7df1bf308c">More...</a><br /></td></tr>
<tr class="separator:a058acbc8e5528a36395b0f7df1bf308c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a96920869e5a9eee9de1df334734df075"><td class="memItemLeft" align="right" valign="top"><a id="a96920869e5a9eee9de1df334734df075"></a>
Share&lt; int &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>speed_SP</b></td></tr>
<tr class="separator:a96920869e5a9eee9de1df334734df075"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62a7cbe15a01bd79ab94915da738e5c5"><td class="memItemLeft" align="right" valign="top"><a id="a62a7cbe15a01bd79ab94915da738e5c5"></a>
Share&lt; int &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>maxMotorSpeed</b></td></tr>
<tr class="separator:a62a7cbe15a01bd79ab94915da738e5c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add4af665148b587f5e95e563624968c9"><td class="memItemLeft" align="right" valign="top"><a id="add4af665148b587f5e95e563624968c9"></a>
<a class="el" href="classmotorEncoder.html">motorEncoder</a>&#160;</td><td class="memItemRight" valign="bottom"><b>myMotorEncoder</b> (motorEncoderPinA, motorEncoderPinB)</td></tr>
<tr class="separator:add4af665148b587f5e95e563624968c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This file contains the implementation of the motor driver class and task. It also contains the class functions for the encoder, and the task to obtain user input.</p>
<dl class="section author"><dt>Author</dt><dd>Jordan Kochavi </dd>
<dd>
Jenny Verheul </dd>
<dd>
Chandler Jones </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2020-Nov-10 </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a9d451d19ddf1b607029c096a6ef6d8c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9d451d19ddf1b607029c096a6ef6d8c2">&#9670;&nbsp;</a></span>motorISR()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void motorISR </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>An interrupt service routine for calculating the speed of the motor. </p>
<p>This ISR is triggered by the rising edge of one of the encoder signals. Each encoder signal outputs a square wave, and each square wave is 90 degrees out of phase. We determine the direction that the motor is spinning by checking which wave is leading. For example, let's say the motor is spinning clockwise. In clockwise rotation, signal A leads signal B. The instant A toggles HIGH on its rising edge, this ISR is run. Since A leads B, if we were to read signal B at precisely the instant that A toggles HIGH, then B should be low, because B toggles HIGH after A does in clockwise rotation. Therefore, if we read signal B using digitalRead(), then a returned value of 0 would mean that the motor is in clockwise (forward) rotation, and if it returns a 1, the motor is in counterclockwise rotation (reverse). After determining the direction of the motor, the ISR updates the encoder to calculate its speed. The timestamp at the current interrupt is also necessary for this calculation. The Arduino function, micros() returns the number of microseconds elapsed since the program started. This value is stored in an unsigned 32-bit integer, which means it has the capacity to overflow. In this case, it resets to 0, and we would not want to calculate the speed of the motor in this case. </p>

</div>
</div>
<a id="a058acbc8e5528a36395b0f7df1bf308c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a058acbc8e5528a36395b0f7df1bf308c">&#9670;&nbsp;</a></span>task_MotorStuff()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void task_MotorStuff </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>p_params</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Task which interacts with a user. </p>
<p>Task functions.</p>
<p>This task demonstrates how to use a FreeRTOS task for interacting with some user while other more important things are going on. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">p_params</td><td>A pointer to function parameters which we don't use. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
